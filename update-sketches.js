// Run with: node update-sketches.js
// Writes sketches-list.js (+ sketches.json) with all sketch .js files in this directory.
// Also supports --watch to auto-regenerate when files change.
//
// sketches-list.js is loaded by index.html via <script> tag, which works on file:// protocol.
// sketches.json is kept for backwards compatibility / other tools.
const fs = require("fs");
const path = require("path");

const dir = __dirname;
// Exclude utility/build scripts – only keep numbered sketch files like "1.xxx.js", "2.xxx.js"
const EXCLUDE_RE = /^(update-sketches|build-assets|assets-data|sketches-list|runner|index)\b/i;

function generateManifest() {
  const files = fs.readdirSync(dir)
    .filter((f) => f.endsWith(".js") && !EXCLUDE_RE.test(f))
    .sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));

  // Write sketches-list.js (primary – loaded via <script> tag, works on file://)
  const jsContent = "// Auto-generated by update-sketches.js – DO NOT EDIT\nwindow.SKETCH_LIST = " + JSON.stringify(files, null, 2) + ";\n";
  fs.writeFileSync(path.join(dir, "sketches-list.js"), jsContent);

  // Write sketches.json (secondary – for tools / fetch-based loading)
  fs.writeFileSync(path.join(dir, "sketches.json"), JSON.stringify(files, null, 2) + "\n");

  console.log(`[sketches] ${files.length} sketches: ${files.join(", ")}`);
  return files;
}

// Run once immediately
generateManifest();

// If --watch flag, keep watching for new/removed .js files
if (process.argv.includes("--watch")) {
  console.log("Watching for .js file changes... (Ctrl+C to stop)");
  let debounce = null;
  fs.watch(dir, (event, filename) => {
    if (filename && filename.endsWith(".js") && !EXCLUDE_RE.test(filename)) {
      clearTimeout(debounce);
      debounce = setTimeout(() => {
        console.log(`\nDetected change: ${filename}`);
        generateManifest();
      }, 300);
    }
  });
}
