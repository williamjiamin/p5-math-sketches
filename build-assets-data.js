// Run once from this folder: node build-assets-data.js
// 1. Writes assets-data.js so profile pics load in the canvas (runner / browser).
// 2. Injects inline fallbacks into 8.Absolute Value.js and 9.Distance Between.js for p5canvas.
const fs = require("fs");
const path = require("path");

const dir = __dirname;
const assetsDir = path.join(dir, "assets");

function toDataUrl(name) {
  const file = path.join(assetsDir, name);
  if (!fs.existsSync(file)) return null;
  const b64 = fs.readFileSync(file).toString("base64");
  return "data:image/png;base64," + b64;
}

const me = toDataUrl("me.png");
const kid = toDataUrl("kid.png");

// 1. Write assets-data.js for runner / index.html
const out = [
  "// Auto-generated by build-assets-data.js â€“ profile pics as data URLs so they load in the canvas.",
  "if (typeof window !== 'undefined') {",
  me ? '  window.ASSET_ME_DATA = ' + JSON.stringify(me) + ";" : "",
  kid ? '  window.ASSET_KID_DATA = ' + JSON.stringify(kid) + ";" : "",
  "}",
].filter(Boolean).join("\n");

fs.writeFileSync(path.join(dir, "assets-data.js"), out);
console.log("Wrote assets-data.js (me:", !!me, "kid:", !!kid, ")");

// 2. Inject inline fallbacks into sketches that use profile pics (for p5canvas extension)
const fallbackBlock = [
  "// ASSET_FALLBACKS_START",
  me ? "const ASSET_ME_DATA_FALLBACK = " + JSON.stringify(me) + ";" : "const ASSET_ME_DATA_FALLBACK = \"\";",
  kid ? "const ASSET_KID_DATA_FALLBACK = " + JSON.stringify(kid) + ";" : "const ASSET_KID_DATA_FALLBACK = \"\";",
  "// ASSET_FALLBACKS_END",
].join("\n");

const sketchFiles = ["8.Absolute Value.js", "9.Distance Between.js"];
for (const filename of sketchFiles) {
  const filePath = path.join(dir, filename);
  if (!fs.existsSync(filePath)) continue;
  let content = fs.readFileSync(filePath, "utf8");
  const startMark = "// ASSET_FALLBACKS_START";
  const endMark = "// ASSET_FALLBACKS_END";
  const startIdx = content.indexOf(startMark);
  const endIdx = content.indexOf(endMark);
  if (startIdx !== -1 && endIdx !== -1 && endIdx > startIdx) {
    content = content.slice(0, startIdx) + fallbackBlock + content.slice(endIdx + endMark.length);
    fs.writeFileSync(filePath, content);
    console.log("Injected fallbacks into", filename);
  }
}
